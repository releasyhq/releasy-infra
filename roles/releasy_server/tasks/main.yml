---
- name: Assert required variables
  ansible.builtin.assert:
    that:
      - releasy_server_database_url is defined
      - releasy_admin_api_key is defined
      - releasy_server_image is defined
      - releasy_server_instances is defined
      - releasy_server_instances | length > 0
    quiet: true

- name: Assert registry credentials when login is enabled
  ansible.builtin.assert:
    that:
      - releasy_registry is defined
      - releasy_registry_username is defined
      - releasy_registry_username | length > 0
      - releasy_registry_password is defined
      - releasy_registry_password | length > 0
    quiet: true
  when: releasy_registry_login_enabled | default(true)

- name: Default env directory
  ansible.builtin.set_fact:
    releasy_server_env_dir: "{{ releasy_env_dir | default('/etc/releasy') }}"
  when: releasy_server_env_dir is not defined or releasy_server_env_dir | length == 0

- name: Default env file path
  ansible.builtin.set_fact:
    releasy_server_env_file: "{{ releasy_env_file | default(releasy_server_env_dir ~ '/releasy.env') }}"
  when: releasy_server_env_file is not defined or releasy_server_env_file | length == 0

- name: Default container port
  ansible.builtin.set_fact:
    releasy_server_container_port: "{{ releasy_container_port | default(releasy_port | default(8080)) }}"
  when: releasy_server_container_port is not defined or releasy_server_container_port | length == 0

- name: Default bind address
  ansible.builtin.set_fact:
    releasy_server_bind_addr: "{{ releasy_bind_addr | default('0.0.0.0:' ~ releasy_server_container_port) }}"
  when: releasy_server_bind_addr is not defined or releasy_server_bind_addr | length == 0

- name: Default extra IP CIDR
  ansible.builtin.set_fact:
    releasy_server_extra_ip_cidr: ""
  when: releasy_server_extra_ip_cidr is not defined

- name: Default operator JWKS TTL seconds
  ansible.builtin.set_fact:
    releasy_server_operator_jwks_ttl_seconds: "{{ releasy_operator_jwks_ttl_seconds | default(300) }}"
  when: releasy_server_operator_jwks_ttl_seconds is not defined

- name: Default operator JWT leeway seconds
  ansible.builtin.set_fact:
    releasy_server_operator_jwt_leeway_seconds: "{{ releasy_operator_jwt_leeway_seconds | default(0) }}"
  when: releasy_server_operator_jwt_leeway_seconds is not defined

- name: Default server container name prefix
  ansible.builtin.set_fact:
    releasy_server_container_name_prefix: >-
      {{ releasy_server_container_name_prefix | default('releasy-server') }}
  when: releasy_server_container_name_prefix is not defined

- name: Collect effective host addresses
  ansible.builtin.set_fact:
    releasy_server_app_host_addrs: >-
      {%- set addrs = [] -%}
      {%- for host in groups.get('releasy_app', []) -%}
      {%-   set addr = (hostvars[host].ansible_host | default(host, true)) | string | trim -%}
      {%-   if addr | length > 0 -%}
      {%-     set _ = addrs.append(addr) -%}
      {%-   endif -%}
      {%- endfor -%}
      {{ addrs }}
    releasy_server_db_host_addrs: >-
      {%- set addrs = [] -%}
      {%- for host in groups.get('releasy_db', []) -%}
      {%-   set addr = (hostvars[host].ansible_host | default(host, true)) | string | trim -%}
      {%-   if addr | length > 0 -%}
      {%-     set _ = addrs.append(addr) -%}
      {%-   endif -%}
      {%- endfor -%}
      {{ addrs }}

- name: Determine single-host mode
  ansible.builtin.set_fact:
    releasy_server_single_host_mode: >-
      {{
        (releasy_server_app_host_addrs | length > 0)
        and (releasy_server_db_host_addrs | length > 0)
        and ((releasy_server_app_host_addrs | unique) | length == 1)
        and ((releasy_server_db_host_addrs | unique) | length == 1)
        and ((releasy_server_app_host_addrs | unique)[0] == (releasy_server_db_host_addrs | unique)[0])
      }}

- name: Collect inventory DB address
  ansible.builtin.set_fact:
    releasy_server_db_host_addr: >-
      {{
        (hostvars[releasy_db_primary_host].ansible_host
          | default(releasy_db_primary_host, true))
        | string
        | trim
      }}
  when: releasy_db_primary_host | default('') | length > 0

- name: Derive inventory DB private IPv4 address
  ansible.builtin.set_fact:
    releasy_server_db_host_private_ipv4: >-
      {{
        releasy_server_db_host_addr
        if releasy_server_db_host_addr is match('^(10\\.|192\\.168\\.|172\\.(1[6-9]|2[0-9]|3[0-1])\\.)')
        else ''
      }}
  when:
    - releasy_db_primary_host | default('') | length > 0
    - releasy_server_db_host_addr is defined

- name: Derive inventory DB primary IPv4 address
  ansible.builtin.set_fact:
    releasy_server_db_host_primary_ipv4: >-
      {{
        (hostvars[releasy_db_primary_host].get('ansible_facts', {}).get('default_ipv4', {}).get('address', '')
          | default(releasy_server_db_host_private_ipv4, true))
        | default(releasy_server_db_host_addr, true)
      }}
  when:
    - releasy_db_primary_host | default('') | length > 0
    - releasy_server_db_host_addr is defined

- name: Initialize Postgres host
  ansible.builtin.set_fact:
    releasy_server_postgres_host: "{{ postgres_host | default(postgres_host_auto | default('')) }}"
  when: releasy_server_postgres_host is not defined

- name: Default Postgres host to DB primary IP on single host without Tailscale
  ansible.builtin.set_fact:
    releasy_server_postgres_host: "{{ releasy_server_db_host_primary_ipv4 }}"
  when:
    - not (tailscale_enabled | default(false))
    - releasy_server_single_host_mode
    - postgres_host_auto is defined
    - releasy_server_postgres_host == postgres_host_auto
    - releasy_server_db_host_primary_ipv4 | length > 0

- name: Default Postgres host to DB primary IP when Tailscale is disabled
  ansible.builtin.set_fact:
    releasy_server_postgres_host: "{{ releasy_server_db_host_primary_ipv4 }}"
  when:
    - not (tailscale_enabled | default(false))
    - not releasy_server_single_host_mode
    - postgres_host_auto is defined
    - releasy_server_postgres_host == postgres_host_auto
    - releasy_server_db_host_primary_ipv4 | length > 0

- name: Install system packages
  ansible.builtin.apt:
    name:
      - ca-certificates
      - docker.io
    update_cache: true

- name: Install UFW when firewall is enabled
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: true
  when: releasy_server_firewall_enabled

- name: Ensure Docker is enabled and running
  ansible.builtin.systemd:
    name: docker
    enabled: true
    state: started

- name: Ensure env directory
  ansible.builtin.file:
    path: "{{ releasy_server_env_dir }}"
    state: directory
    owner: "root"
    group: "root"
    mode: "0750"

- name: Build extra IP CIDR (optional)
  ansible.builtin.set_fact:
    releasy_server_extra_ip_cidr: >-
      {{
        releasy_extra_ip if '/' in releasy_extra_ip
        else releasy_extra_ip ~ '/32'
      }}
  when: releasy_extra_ip is defined and releasy_extra_ip | length > 0

- name: Check extra IP assignment (optional)
  ansible.builtin.command: "ip -4 addr show dev {{ releasy_extra_ip_iface }}"
  register: releasy_server_extra_ip_status
  changed_when: false
  when: releasy_extra_ip is defined and releasy_extra_ip | length > 0

- name: Assign extra IP to interface (optional)
  ansible.builtin.command: >-
    ip addr add {{ releasy_server_extra_ip_cidr }} dev {{ releasy_extra_ip_iface }}
  changed_when: true
  when:
    - releasy_extra_ip is defined
    - releasy_extra_ip | length > 0
    - releasy_server_extra_ip_cidr not in releasy_server_extra_ip_status.stdout

- name: Build netplan addresses for extra IP (optional)
  ansible.builtin.set_fact:
    releasy_server_extra_ip_netplan_addresses: >-
      {{
        (
          [releasy_server_extra_ip_cidr | default('')]
          + (
            [
              ansible_facts["default_ipv6"]["address"] ~ '/' ~ ansible_facts["default_ipv6"]["prefix"]
            ]
            if (releasy_extra_ip_preserve_ipv6 | default(false))
            and (ansible_facts["default_ipv6"] is defined)
            and (ansible_facts["default_ipv6"]["address"] is defined)
            and (ansible_facts["default_ipv6"]["prefix"] is defined)
            else []
          )
          + (releasy_extra_ip_netplan_additional_addresses | default([]))
        ) | unique
      }}
  when:
    - releasy_extra_ip is defined
    - releasy_extra_ip | length > 0
    - releasy_extra_ip_persistent | default(false)

- name: Render netplan config for extra IP (optional)
  ansible.builtin.template:
    src: releasy.floating-ip.netplan.yml.j2
    dest: "{{ releasy_extra_ip_netplan_path | default('/etc/netplan/99-releasy-floating-ip.yaml') }}"
    owner: root
    group: root
    mode: "0600"
  notify: Apply netplan
  when:
    - releasy_extra_ip is defined
    - releasy_extra_ip | length > 0
    - releasy_extra_ip_persistent | default(false)

- name: Build backend docker args
  ansible.builtin.set_fact:
    releasy_server_docker_extra_args_effective: >-
      {{
        (releasy_server_docker_extra_args | default([]))
        + (['--dns=100.100.100.100'] if (tailscale_enabled | default(false)) else [])
      }}

- name: Wait for Postgres to be reachable from app host
  ansible.builtin.wait_for:
    host: "{{ releasy_server_postgres_host }}"
    port: "{{ postgres_port | default(5432) }}"
    timeout: "{{ releasy_db_connect_timeout | default(30) }}"
    state: started

- name: Log in to container registry
  ansible.builtin.command: "docker login {{ releasy_registry }} -u {{ releasy_registry_username }} --password-stdin"
  args:
    stdin: "{{ releasy_registry_password }}"
  changed_when: false
  no_log: true
  when: releasy_registry_login_enabled | default(true)

- name: Pull server image
  ansible.builtin.command: "docker pull {{ releasy_server_image }}"
  register: releasy_server_pull
  changed_when: >-
    (releasy_server_pull_always | default(false))
    or ('Downloaded newer image' in (releasy_server_pull.stdout | default('')))

- name: Render server environment file
  ansible.builtin.template:
    src: releasy.env.j2
    dest: "{{ releasy_server_env_file }}"
    owner: root
    group: root
    mode: "0600"
  no_log: true
  register: releasy_server_env

- name: Render per-instance environment files
  ansible.builtin.template:
    src: releasy.instance.env.j2
    dest: "{{ releasy_server_env_dir }}/releasy-{{ item }}.env"
    owner: root
    group: root
    mode: "0600"
  loop: "{{ releasy_server_instances }}"
  loop_control:
    index_var: instance_index
  vars:
    instance_port: "{{ (releasy_server_instance_port_base | default(releasy_port) | int) + instance_index }}"
  register: releasy_server_instance_envs
  no_log: true

- name: Install server systemd template
  ansible.builtin.template:
    src: releasy@.service.j2
    dest: "/etc/systemd/system/releasy-server@.service"
    owner: root
    group: root
    mode: "0644"
  register: releasy_server_unit
  notify: Reload systemd

- name: Flush handlers after systemd unit update
  ansible.builtin.meta: flush_handlers

- name: Stop legacy releasy-server service if present
  ansible.builtin.systemd:
    name: "{{ releasy_service_name | default('releasy-server') }}"
    enabled: false
    state: stopped
  failed_when: false

- name: Ensure server instances are enabled and running
  ansible.builtin.systemd:
    name: "releasy-server@{{ item }}"
    enabled: true
    state: started
  loop: "{{ releasy_server_instances }}"

- name: Determine rolling restart requirement
  ansible.builtin.set_fact:
    releasy_server_restart_required: >-
      {{
        releasy_server_env.changed
        or releasy_server_instance_envs.changed
        or releasy_server_unit.changed
        or (releasy_server_pull is defined and releasy_server_pull.changed)
      }}

- name: Rolling restart server instances
  ansible.builtin.include_tasks: rolling_restart.yml
  when: releasy_server_restart_required | default(false)
  loop: "{{ releasy_server_instances }}"
  loop_control:
    index_var: instance_index
    loop_var: releasy_server_instance

- name: Default deny incoming (optional)
  ansible.builtin.command: ufw default deny incoming
  register: releasy_server_ufw_default_deny
  when: releasy_server_firewall_enabled and releasy_server_firewall_default_deny_incoming
  changed_when: "'changed' in (releasy_server_ufw_default_deny.stdout | lower)"
  notify: Show UFW rules

- name: Remove legacy OpenSSH allow rules
  ansible.builtin.command: ufw delete allow OpenSSH
  register: releasy_server_ufw_delete_openssh
  changed_when: "'Skipping' not in releasy_server_ufw_delete_openssh.stdout"
  failed_when: false
  when: releasy_server_firewall_enabled and releasy_server_firewall_allow_ssh
  notify: Show UFW rules

- name: Remove legacy SSH deny rules
  ansible.builtin.command: "ufw delete deny {{ item }}"
  register: releasy_server_ufw_delete_ssh_denies
  changed_when: "'Skipping' not in releasy_server_ufw_delete_ssh_denies.stdout"
  failed_when: false
  loop:
    - "22/tcp"
    - "ssh"
  when: releasy_server_firewall_enabled and releasy_server_firewall_allow_ssh
  notify: Show UFW rules

- name: Allow SSH from specific sources
  ansible.builtin.command: "ufw allow from {{ item }} to any port 22 proto tcp"
  register: releasy_server_ufw_allow_ssh_result
  changed_when: "'Skipping' not in releasy_server_ufw_allow_ssh_result.stdout"
  loop: "{{ releasy_server_firewall_ssh_sources }}"
  when: releasy_server_firewall_enabled
    and releasy_server_firewall_allow_ssh
    and (releasy_server_firewall_ssh_sources | length > 0)
  notify: Show UFW rules

- name: Allow SSH (fallback)
  ansible.builtin.command: ufw allow OpenSSH
  register: releasy_server_ufw_allow_openssh
  when: releasy_server_firewall_enabled
    and releasy_server_firewall_allow_ssh
    and (releasy_server_firewall_ssh_sources | length == 0)
  changed_when: "'Skipping' not in releasy_server_ufw_allow_openssh.stdout"
  notify: Show UFW rules

- name: Explicitly deny SSH from other sources
  ansible.builtin.command: ufw deny 22/tcp
  register: releasy_server_ufw_deny_ssh
  when: releasy_server_firewall_enabled
    and releasy_server_firewall_allow_ssh
    and releasy_server_firewall_explicit_deny_ssh
  changed_when: "'Skipping' not in releasy_server_ufw_deny_ssh.stdout"
  notify: Show UFW rules

- name: Enable UFW if requested
  ansible.builtin.command: ufw --force enable
  when: releasy_server_firewall_enabled and releasy_server_firewall_enable_ufw
  changed_when: false

- name: Allow proxy sources to reach server ports
  ansible.builtin.command: "ufw allow from {{ item.0 }} to any port {{ item.1 }} proto tcp"
  register: releasy_server_ufw_allow_result
  changed_when: "'Skipping' not in releasy_server_ufw_allow_result.stdout"
  loop: >-
    {{ releasy_server_firewall_allowed_sources
       | product(range(releasy_server_instance_port_base | default(releasy_port) | int,
                       (releasy_server_instance_port_base | default(releasy_port) | int)
                       + (releasy_server_instances | length)))
       | list }}
  when: releasy_server_firewall_enabled
    and (releasy_server_firewall_allowed_sources | length > 0)
  notify: Show UFW rules
