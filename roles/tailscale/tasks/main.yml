---
- name: Assert supported OS
  ansible.builtin.assert:
    that:
      - ansible_facts["distribution"] | lower in ["ubuntu", "debian"]
    fail_msg: "Tailscale role supports Ubuntu/Debian only."
    quiet: true

- name: Ensure curl is installed
  ansible.builtin.apt:
    name:
      - curl
      - ca-certificates
    state: present
    update_cache: true

- name: Check curl is available
  ansible.builtin.command: which curl
  register: tailscale_curl_check
  changed_when: false
  failed_when: false

- name: Assert curl is available
  ansible.builtin.assert:
    that:
      - tailscale_curl_check.rc == 0
    fail_msg: >-
      curl is required to install Tailscale via install.sh. Install it
      first (Ubuntu/Debian: apt-get update && apt-get install -y curl).
    quiet: true

- name: Install Tailscale via install.sh
  ansible.builtin.shell: |
    set -euo pipefail
    curl -fsSL https://tailscale.com/install.sh | sh
  args:
    creates: /usr/bin/tailscale
    executable: /bin/bash

- name: Ensure tailscaled is enabled and running
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started

- name: Read Tailscale status
  ansible.builtin.command: tailscale status --json
  register: tailscale_status
  changed_when: false
  failed_when: false

- name: Default Tailscale status facts
  ansible.builtin.set_fact:
    tailscale_backend_state: ""
    tailscale_logged_in: false
    tailscale_current_hostname: ""
    tailscale_current_tags: []
    tailscale_dns_name: ""
  when: tailscale_status.rc != 0

- name: Parse Tailscale status facts
  ansible.builtin.set_fact:
    tailscale_backend_state: "{{ (tailscale_status.stdout | from_json).BackendState | default('', true) }}"
    tailscale_logged_in: "{{ (tailscale_status.stdout | from_json).BackendState | default('', true) == 'Running' }}"
    tailscale_current_hostname: "{{ (tailscale_status.stdout | from_json).Self.HostName | default('', true) }}"
    tailscale_current_tags: "{{ (tailscale_status.stdout | from_json).Self.Tags | default([], true) }}"
    tailscale_dns_name: >-
      {{
        (tailscale_status.stdout | from_json).Self.DNSName
        | default('', true)
        | regex_replace('\\.$', '')
      }}
  when: tailscale_status.rc == 0

- name: Determine whether to run tailscale up
  ansible.builtin.set_fact:
    tailscale_up_required: >-
      {{
        (tailscale_backend_state != 'Running')
        or (tailscale_hostname != tailscale_current_hostname)
        or ((tailscale_advertise_tags | default([]) | sort) != (tailscale_current_tags | default([]) | sort))
      }}

- name: Assert auth key for first-time login
  ansible.builtin.assert:
    that:
      - tailscale_auth_key is defined
      - tailscale_auth_key | length > 0
    fail_msg: "tailscale_auth_key must be set in inventory/group_vars/all/vault.yml."
    quiet: true
  when: tailscale_up_required and (tailscale_backend_state != 'Running')

- name: Build tailscale up argv
  ansible.builtin.set_fact:
    tailscale_up_argv: >-
      {{
        ['tailscale', 'up',
         '--hostname=' ~ tailscale_hostname] +
        (((tailscale_advertise_tags | length) == 0)
          | ternary(['--reset'], [])) +
        (((tailscale_advertise_tags | length) > 0)
          | ternary(['--advertise-tags=' ~ (tailscale_advertise_tags | join(','))], [])) +
        ((tailscale_backend_state != 'Running')
          | ternary(['--authkey=' ~ tailscale_auth_key], []))
      }}
  when: tailscale_up_required

- name: Run tailscale up
  ansible.builtin.command:
    argv: "{{ tailscale_up_argv }}"
  register: tailscale_up_result
  changed_when: tailscale_up_result.rc == 0
  failed_when: false
  no_log: true
  when: tailscale_up_required

- name: Fail when tailscale up rejected tags
  ansible.builtin.fail:
    msg: >-
      tailscale up failed because the requested tags are not permitted.
      Update the Tailnet ACL tagOwners for {{ tailscale_advertise_tags | join(', ') }}
      and create a pre-auth key that allows those tags, or remove
      tailscale_advertise_tags.
  when: tailscale_up_required
    and tailscale_up_result.rc != 0
    and (tailscale_advertise_tags | length > 0)
    and ("not permitted" in (tailscale_up_result.stderr | default('') | lower)
         or "invalid" in (tailscale_up_result.stderr | default('') | lower))

- name: Fail when tailscale up failed
  ansible.builtin.fail:
    msg: >-
      tailscale up failed (rc={{ tailscale_up_result.rc }}). Check
      tailscaled logs or run 'tailscale status --json' on the host.
  when: tailscale_up_required
    and tailscale_up_result.rc != 0
    and not (
      (tailscale_advertise_tags | length > 0)
      and ("not permitted" in (tailscale_up_result.stderr | default('') | lower)
           or "invalid" in (tailscale_up_result.stderr | default('') | lower))
    )
