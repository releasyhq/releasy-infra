---
- name: Assert required variables
  ansible.builtin.assert:
    that:
      - traefik_acme_email is defined
    quiet: true

- name: Assert Releasy public host when enabled
  ansible.builtin.assert:
    that:
      - releasy_public_host is defined
      - releasy_public_host | length > 0
    quiet: true
  when: traefik_releasy_enabled | default(true)

- name: Resolve Traefik architecture
  ansible.builtin.set_fact:
    traefik_arch: "{{ traefik_arch | default(_traefik_arch_map.get(ansible_facts['architecture'], '')) }}"
  vars:
    _traefik_arch_map:
      aarch64: arm64
      arm64: arm64
      amd64: amd64
      x86_64: amd64

- name: Assert Traefik architecture is supported
  ansible.builtin.assert:
    that:
      - traefik_arch | length > 0
    quiet: true
    fail_msg: >-
      Unsupported architecture {{ ansible_facts['architecture'] }} for Traefik.
      Set traefik_arch explicitly to a supported value (amd64/arm64).

- name: Install system packages
  ansible.builtin.apt:
    name:
      - curl
      - ca-certificates
      - libcap2-bin
    update_cache: true

- name: Ensure traefik group
  ansible.builtin.group:
    name: traefik
    system: true

- name: Ensure traefik user
  ansible.builtin.user:
    name: traefik
    group: traefik
    home: /var/lib/traefik
    create_home: true
    system: true
    shell: /usr/sbin/nologin

- name: Ensure traefik directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "/etc/traefik", owner: "root", group: "root", mode: "0755" }
    - { path: "/etc/traefik/dynamic", owner: "root", group: "root", mode: "0755" }
    - { path: "/var/lib/traefik", owner: "traefik", group: "traefik", mode: "0750" }

- name: Download Traefik
  ansible.builtin.get_url:
    url: "https://github.com/traefik/traefik/releases/download/v{{ traefik_version }}/traefik_v{{ traefik_version }}_linux_{{ traefik_arch }}.tar.gz"
    dest: "/tmp/traefik_{{ traefik_version }}_{{ traefik_arch }}.tar.gz"
    mode: "0644"

- name: Ensure Traefik extract directory
  ansible.builtin.file:
    path: "/tmp/traefik_{{ traefik_version }}_{{ traefik_arch }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Extract Traefik
  ansible.builtin.unarchive:
    src: "/tmp/traefik_{{ traefik_version }}_{{ traefik_arch }}.tar.gz"
    dest: "/tmp/traefik_{{ traefik_version }}_{{ traefik_arch }}"
    remote_src: true
    creates: "/tmp/traefik_{{ traefik_version }}_{{ traefik_arch }}/traefik"

- name: Install Traefik binary
  ansible.builtin.copy:
    src: "/tmp/traefik_{{ traefik_version }}_{{ traefik_arch }}/traefik"
    dest: /usr/local/bin/traefik
    owner: root
    group: root
    mode: "0755"
    remote_src: true
  notify: Restart traefik

- name: Allow Traefik to bind low ports
  ansible.builtin.command: setcap 'cap_net_bind_service=+ep' /usr/local/bin/traefik
  changed_when: false

- name: Ensure ACME storage exists
  ansible.builtin.file:
    path: /var/lib/traefik/acme.json
    state: touch
    owner: traefik
    group: traefik
    mode: "0600"

- name: Render Traefik static config
  ansible.builtin.template:
    src: traefik.yml.j2
    dest: /etc/traefik/traefik.yml
    owner: root
    group: root
    mode: "0644"
  notify: Restart traefik

- name: Default Traefik rate limit settings
  ansible.builtin.set_fact:
    traefik_rate_limit_average: "{{ traefik_rate_limit_average | default(1) }}"
    traefik_rate_limit_burst: "{{ traefik_rate_limit_burst | default(30) }}"
    traefik_keycloak_rate_limit_average: "{{ traefik_keycloak_rate_limit_average | default(20) }}"
    traefik_keycloak_rate_limit_burst: "{{ traefik_keycloak_rate_limit_burst | default(100) }}"

- name: Use configured Releasy upstreams when provided
  ansible.builtin.set_fact:
    traefik_releasy_server_upstreams: "{{ releasy_server_upstreams }}"
  when:
    - traefik_releasy_enabled | default(true)
    - releasy_server_upstreams is defined

- name: Default Releasy upstreams from app hosts
  ansible.builtin.set_fact:
    traefik_releasy_server_upstreams: >-
      {%- set upstreams = [] -%}
      {%- for host in groups.get('releasy_app', []) -%}
      {%-   set host_ip = (hostvars[host].ansible_host | default(host, true)) | string | trim -%}
      {%-   if host_ip | length > 0 -%}
      {%-     set base_port = (hostvars[host].releasy_server_instance_port_base
      | default(hostvars[host].releasy_port | default(8080))) | int -%}
      {%-     set instances = hostvars[host].releasy_server_instances | default(['blue', 'green']) -%}
      {%-     for idx in range(0, instances | length) -%}
      {%-       set _ = upstreams.append('http://' ~ host_ip ~ ':' ~ (base_port + idx)) -%}
      {%-     endfor -%}
      {%-   endif -%}
      {%- endfor -%}
      {{ upstreams }}
  when:
    - traefik_releasy_enabled | default(true)
    - traefik_releasy_server_upstreams is not defined

- name: Assert Releasy upstreams are available
  ansible.builtin.assert:
    that:
      - traefik_releasy_server_upstreams is defined
      - traefik_releasy_server_upstreams | length > 0
    quiet: true
    fail_msg: >-
      traefik_releasy_server_upstreams is empty. Define releasy_server_upstreams
      explicitly or add at least one host to the releasy_app group with
      releasy_server_instances and instance ports.
  when: traefik_releasy_enabled | default(true)

- name: Render Traefik dynamic config
  ansible.builtin.template:
    src: dynamic.yml.j2
    dest: /etc/traefik/dynamic/releasy.yml
    owner: root
    group: root
    mode: "0644"
  notify: Restart traefik

- name: Install systemd service
  ansible.builtin.template:
    src: traefik.service.j2
    dest: /etc/systemd/system/traefik.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart traefik

- name: Ensure Traefik is enabled and running
  ansible.builtin.systemd:
    name: traefik
    enabled: true
    state: started
