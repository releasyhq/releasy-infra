http:
  routers:
{% if traefik_releasy_enabled | default(true) %}
    releasy-http:
      rule: "Host(`{{ releasy_public_host }}`)"
      entryPoints:
        - web
      middlewares:
        - redirect-to-https
      service: releasy-server
    releasy-https:
      rule: "Host(`{{ releasy_public_host }}`)"
      entryPoints:
        - websecure
      middlewares:
        - rate-limit
      tls:
        certResolver: letsencrypt
      service: releasy-server
{% endif %}
{% if keycloak_public_host | default('') and (keycloak_upstreams | default([]) | length > 0) %}
    keycloak-http:
      rule: "Host(`{{ keycloak_public_host }}`)"
      entryPoints:
        - web
      middlewares:
        - redirect-to-https
      service: keycloak
    keycloak-https:
      rule: "Host(`{{ keycloak_public_host }}`)"
      entryPoints:
        - websecure
      middlewares:
        - keycloak-rate-limit
      tls:
        certResolver: letsencrypt
      service: keycloak
{% endif %}

  services:
{% if traefik_releasy_enabled | default(true) %}
    releasy-server:
      loadBalancer:
{% if traefik_releasy_server_healthcheck_enabled | default(true) %}
        healthCheck:
          path: "{{ traefik_releasy_server_healthcheck_path }}"
          interval: "{{ traefik_releasy_server_healthcheck_interval }}"
          timeout: "{{ traefik_releasy_server_healthcheck_timeout }}"
{% endif %}
        servers:
        {% for upstream in traefik_releasy_server_upstreams %}
          - url: "{{ upstream }}"
        {% endfor %}
{% endif %}
{% if keycloak_public_host | default('') and (keycloak_upstreams | default([]) | length > 0) %}
    keycloak:
      loadBalancer:
{% if keycloak_traefik_sticky | default(false) %}
        sticky:
          cookie:
            name: "{{ keycloak_traefik_sticky_cookie_name | default('KEYCLOAK_STICKY') }}"
            httpOnly: true
            secure: true
{% endif %}
        servers:
        {% for upstream in keycloak_upstreams %}
          - url: "{{ upstream }}"
        {% endfor %}
{% endif %}

  middlewares:
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true
    rate-limit:
      rateLimit:
        average: {{ traefik_rate_limit_average }}
        burst: {{ traefik_rate_limit_burst }}
    keycloak-rate-limit:
      rateLimit:
        average: {{ traefik_keycloak_rate_limit_average }}
        burst: {{ traefik_keycloak_rate_limit_burst }}
