---
- name: Restart Keycloak instance
  ansible.builtin.systemd:
    name: "keycloak@{{ keycloak_instance }}"
    state: restarted

- name: Wait for Keycloak port
  ansible.builtin.wait_for:
    host: "127.0.0.1"
    port: "{{ (keycloak_instance_port_base | default(keycloak_http_port | default(8080)) | int) + instance_index }}"
    delay: 5
    timeout: "{{ keycloak_healthcheck_timeout | default(120) }}"

- name: Check Keycloak health endpoint
  ansible.builtin.uri:
    url: >-
      {{ "http://127.0.0.1:" ~
         ((keycloak_instance_port_base | default(keycloak_http_port
           | default(8080)) | int) + instance_index) ~
         (keycloak_healthcheck_path | default('/health/ready')) }}
    status_code: 200
    timeout: 5
  register: keycloak_healthcheck
  retries: "{{ keycloak_healthcheck_retries | default(15) }}"
  delay: "{{ keycloak_healthcheck_delay | default(4) }}"
  until: keycloak_healthcheck.status | default(0) == 200
