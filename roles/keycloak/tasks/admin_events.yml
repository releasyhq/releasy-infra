---
- name: Fetch Keycloak realm settings for admin events
  ansible.builtin.uri:
    url: "{{ keycloak_admin_base_url }}/admin/realms/{{ keycloak_realm_name }}"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_admin_access_token }}"
    status_code: 200
  register: keycloak_admin_events_realm
  no_log: true

- name: Build Keycloak admin events update payload
  ansible.builtin.set_fact:
    keycloak_admin_events_payload: "{{ keycloak_admin_events_payload_base | combine(keycloak_admin_events_payload_optional) }}"
  vars:
    keycloak_admin_events_payload_base:
      id: "{{ keycloak_admin_events_realm.json.id | default(omit) }}"
      realm: "{{ keycloak_admin_events_realm.json.realm | default(keycloak_realm_name) }}"
      enabled: "{{ keycloak_admin_events_realm.json.enabled | default(true) }}"
      adminEventsEnabled: "{{ keycloak_admin_events_enabled | bool }}"
      adminEventsDetailsEnabled: "{{ keycloak_admin_events_details_enabled | bool }}"
    keycloak_admin_events_payload_optional: >-
      {{
        {}
        | combine({'smtpServer': keycloak_admin_events_realm.json.smtpServer}
                  if keycloak_admin_events_realm.json.smtpServer is defined else {})
      }}
  no_log: true

- name: Update Keycloak admin events settings
  ansible.builtin.uri:
    url: "{{ keycloak_admin_base_url }}/admin/realms/{{ keycloak_realm_name }}"
    method: PUT
    headers:
      Authorization: "Bearer {{ keycloak_admin_access_token }}"
    body_format: json
    body: "{{ keycloak_admin_events_payload }}"
    status_code: 204
  no_log: true
  when: >-
    (keycloak_admin_events_realm.json.adminEventsEnabled | default(false) | bool)
      != (keycloak_admin_events_enabled | bool)
    or (keycloak_admin_events_realm.json.adminEventsDetailsEnabled | default(false) | bool)
      != (keycloak_admin_events_details_enabled | bool)
