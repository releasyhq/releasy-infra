---
- name: Assert required variables
  ansible.builtin.assert:
    that:
      - keycloak_admin_user is defined
      - keycloak_admin_password is defined
      - keycloak_db_password is defined
      - keycloak_hostname is defined
      - keycloak_db_host is defined
      - keycloak_db_name is defined
      - keycloak_db_user is defined
      - keycloak_instances is defined
      - keycloak_instances | length > 0
    quiet: true

- name: Assert realm client secret for template import
  ansible.builtin.assert:
    that:
      - keycloak_portal_client_secret is defined
      - keycloak_portal_client_secret | length > 0
    fail_msg: "keycloak_portal_client_secret must be set when realm import uses the template."
    quiet: true
  when: keycloak_realm_import_enabled | default(false)
    and keycloak_realm_import_source == "template"

- name: Install Docker
  ansible.builtin.apt:
    name:
      - docker.io
    state: present
    update_cache: true

- name: Ensure Docker is enabled and running
  ansible.builtin.systemd:
    name: docker
    enabled: true
    state: started

- name: Ensure Keycloak data directory
  ansible.builtin.file:
    path: "{{ keycloak_data_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0770"

- name: Ensure Keycloak data tmp directory
  ansible.builtin.file:
    path: "{{ keycloak_data_dir }}/tmp"
    state: directory
    owner: root
    group: root
    mode: "0770"

- name: Ensure Keycloak env directory
  ansible.builtin.file:
    path: "{{ keycloak_env_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure Keycloak import directory
  ansible.builtin.file:
    path: "{{ keycloak_data_dir }}/import"
    state: directory
    owner: root
    group: root
    mode: "0770"
  when: keycloak_realm_import_enabled | default(false)

- name: Assert realm import source exists
  ansible.builtin.stat:
    path: "{{ keycloak_realm_import_src }}"
  register: keycloak_realm_import_stat
  delegate_to: localhost
  run_once: true
  when: keycloak_realm_import_enabled | default(false)
    and keycloak_realm_import_source == "file"

- name: Assert realm import source present
  ansible.builtin.assert:
    that:
      - keycloak_realm_import_src | length > 0
      - keycloak_realm_import_stat.stat.exists
    fail_msg: "keycloak_realm_import_src must point to a readable realm file."
    quiet: true
  when: keycloak_realm_import_enabled | default(false)
    and keycloak_realm_import_source == "file"

- name: Render Keycloak realm import template
  ansible.builtin.template:
    src: realm.json.j2
    dest: "{{ keycloak_data_dir }}/import/{{ keycloak_realm_import_dest }}"
    owner: root
    group: root
    mode: "0644"
  when: keycloak_realm_import_enabled | default(false)
    and keycloak_realm_import_source == "template"
  register: keycloak_realm_template

- name: Copy Keycloak realm import file
  ansible.builtin.copy:
    src: "{{ keycloak_realm_import_src }}"
    dest: "{{ keycloak_data_dir }}/import/{{ keycloak_realm_import_dest }}"
    owner: root
    group: root
    mode: "0644"
  when: keycloak_realm_import_enabled | default(false)
    and keycloak_realm_import_source == "file"
  register: keycloak_realm_copy

- name: Render Keycloak environment file
  ansible.builtin.template:
    src: keycloak.env.j2
    dest: "{{ keycloak_env_file }}"
    owner: root
    group: root
    mode: "0600"
  no_log: true
  register: keycloak_env

- name: Render per-instance environment files
  ansible.builtin.template:
    src: keycloak.instance.env.j2
    dest: "{{ keycloak_env_dir }}/keycloak-{{ item }}.env"
    owner: root
    group: root
    mode: "0600"
  loop: "{{ keycloak_instances }}"
  loop_control:
    index_var: instance_index
  vars:
    instance_port: "{{ (keycloak_instance_port_base | default(keycloak_http_port | default(8080)) | int) + instance_index }}"
  no_log: true
  register: keycloak_instance_envs

- name: Render Keycloak run script
  ansible.builtin.template:
    src: keycloak-run.sh.j2
    dest: /usr/local/bin/keycloak-run
    owner: root
    group: root
    mode: "0755"
  register: keycloak_run_script

- name: Install Keycloak systemd template
  ansible.builtin.template:
    src: keycloak@.service.j2
    dest: /etc/systemd/system/keycloak@.service
    owner: root
    group: root
    mode: "0644"
  register: keycloak_unit
  notify: Reload systemd

- name: Reload systemd when unit changes
  ansible.builtin.meta: flush_handlers

- name: Stop legacy keycloak service if present
  ansible.builtin.systemd:
    name: keycloak
    enabled: false
    state: stopped
  failed_when: false

- name: Ensure Keycloak instances are enabled and running
  ansible.builtin.systemd:
    name: "keycloak@{{ item }}"
    enabled: true
    state: started
    daemon_reload: true
  loop: "{{ keycloak_instances }}"

- name: Determine rolling restart requirement
  ansible.builtin.set_fact:
    keycloak_restart_required: >-
      {{
        keycloak_env.changed
        or keycloak_instance_envs.changed
        or (keycloak_run_script is defined and keycloak_run_script.changed)
        or keycloak_unit.changed
        or (keycloak_realm_template is defined and keycloak_realm_template.changed)
        or (keycloak_realm_copy is defined and keycloak_realm_copy.changed)
      }}

- name: Rolling restart Keycloak instances
  ansible.builtin.include_tasks: rolling_restart.yml
  when: keycloak_restart_required | default(false)
  loop: "{{ keycloak_instances }}"
  loop_control:
    index_var: instance_index
    loop_var: keycloak_instance

- name: Request Keycloak admin access token
  ansible.builtin.uri:
    url: >-
      {{ keycloak_admin_base_url }}/realms/{{ keycloak_admin_realm }}
      /protocol/openid-connect/token
    method: POST
    body_format: form-urlencoded
    body:
      grant_type: password
      client_id: admin-cli
      username: "{{ keycloak_admin_user }}"
      password: "{{ keycloak_admin_password }}"
    status_code: 200
  register: keycloak_admin_token
  no_log: true
  retries: 6
  delay: 5
  until: keycloak_admin_token.json.access_token is defined
  when: keycloak_service_account_client_roles | length > 0

- name: Set Keycloak admin access token
  ansible.builtin.set_fact:
    keycloak_admin_access_token: "{{ keycloak_admin_token.json.access_token }}"
  no_log: true
  when: keycloak_service_account_client_roles | length > 0

- name: Ensure Keycloak service account roles
  ansible.builtin.include_tasks: service_account_roles.yml
  loop: "{{ keycloak_service_account_client_roles }}"
  loop_control:
    loop_var: keycloak_service_account_mapping
  when: keycloak_service_account_client_roles | length > 0
